name: Vaultwarden Build (Linux)

on:
  workflow_dispatch:
    inputs:
      tag_choice:
        description: "版本选择"
        required: true
        default: "release"
        type: choice
        options:
          - release
          - latest
          - custom
      tag:
        description: "自定义 commit"
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    # 设置超时时间，避免长时间运行被系统取消 [3,7](@ref)
    timeout-minutes: 55  # 设置为55分钟，低于GitHub的60分钟硬限制

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: 检查工具版本
        run: |
          git version
          cargo version
          apt --version

      - name: vaultwarden 版本选择
        id: get_tag
        run: |
          if [ "${{ github.event.inputs.tag_choice }}" = "release" ]; then
            RELEASE_API_RESPONSE=$(curl -s https://api.github.com/repos/dani-garcia/vaultwarden/releases/latest)
            TAG_NAME=$(echo "$RELEASE_API_RESPONSE" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
            echo "Using release tag: $TAG_NAME"
            echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.tag_choice }}" = "latest" ]; then
            echo "Using latest commit"
            echo "tag=" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.tag_choice }}" = "custom" ]; then
            echo "Using custom tag: ${{ github.event.inputs.tag }}"
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          fi

      - name: 克隆 vaultwarden 仓库
        run: git clone https://github.com/dani-garcia/vaultwarden

      - name: 切换版本
        if: ${{ steps.get_tag.outputs.tag != '' }}
        run: git switch --detach "${{ steps.get_tag.outputs.tag }}"
        working-directory: vaultwarden

      - name: 下载 web-vault
        run: |
          RELEASE_API_RESPONSE=$(curl -s https://api.github.com/repos/dani-garcia/bw_web_builds/releases/latest)
          DOWNLOAD_URL=$(echo "$RELEASE_API_RESPONSE" | grep -o '"browser_download_url": "[^"]*\.tar\.gz"' | head -1 | cut -d'"' -f4)
          FILENAME=$(echo "$DOWNLOAD_URL" | rev | cut -d/ -f1 | rev)

          if [ -z "$DOWNLOAD_URL" ]; then
            echo "::error::No .tar.gz asset found."
            exit 1
          fi

          echo "Downloading $FILENAME..."
          curl -L -o "$FILENAME" "$DOWNLOAD_URL"

          mkdir -p web-vault
          echo "Extracting..."
          tar -xzf "$FILENAME" -C web-vault --strip-components=1

      - name: 安装系统依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev

      - name: 设置 Rust 缓存
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            vaultwarden/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: 编译 vaultwarden
        run: cargo build --features postgresql --release
        working-directory: vaultwarden

      - name: 移动文件
        run: mv ./vaultwarden/target/release/vaultwarden ./vaultwarden_linux

      - name: 版本信息
        id: get_version
        run: |
          VERSION_OUTPUT=$(./vaultwarden_linux -v)
          VAULTWARDEN_VERSION=$(echo "$VERSION_OUTPUT" | grep -oP 'Vaultwarden \K(\S+)' | head -1)
          WEB_VAULT_VERSION=$(echo "$VERSION_OUTPUT" | grep -oP 'Web-Vault \K(\S+)' | head -1)

          echo "Vaultwarden version: $VAULTWARDEN_VERSION"
          echo "Web-Vault version: $WEB_VAULT_VERSION"
          echo "vaultwarden_version=$VAULTWARDEN_VERSION" >> $GITHUB_OUTPUT
          echo "web_vault_version=$WEB_VAULT_VERSION" >> $GITHUB_OUTPUT

      - name: 打包文件
        uses: actions/upload-artifact@v4
        with:
          name: Vaultwarden_Linux_${{ steps.get_version.outputs.vaultwarden_version }}
          path: |
            vaultwarden_linux
            web-vault/
